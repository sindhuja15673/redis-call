
 <!DOCTYPE html>
 <html lang="en">
 <head>
   <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>Call Queue Dashboard</title>
 
   <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
   <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
 
   <style>
     body { font-family: Inter, Arial, sans-serif; margin:18px; background:#fafafa; color:#222; }
     .container { max-width:1100px; margin:auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
     .grid { display:grid; grid-template-columns:1fr 360px; gap:14px; }
     .panel { border:1px solid #eee; padding:12px; border-radius:8px; }
     .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
     .kpi { flex:1; min-width:160px; background:#f7fbf8; padding:10px; border-radius:8px; border:1px solid #edf6ee; }
     .label { font-size:12px; color:#666; }
     .value { font-size:18px; font-weight:600; margin-top:6px; }
     .rates { display:flex; gap:8px; margin-top:8px; }
     .rate-pill { background:#f1f7ff; border:1px solid #e6f0ff; padding:6px 10px; border-radius:999px; font-size:13px; }
     .upload-box { border:1px dashed #ccc; padding:14px; border-radius:8px; margin-top:24px; }
     button { background:#2563eb; color:#fff; border:0; border-radius:6px; padding:8px 12px; cursor:pointer; }
     button.secondary { background:#6b7280; }
     button.warn { background:#ef4444; }
     #exportOut { background:#f7f7fb; height:360px; overflow:auto; padding:8px; border-radius:6px; }
     @media(max-width:980px){ .grid{grid-template-columns:1fr;} }
   </style>
 </head>
 
 <body>
 <div class="container">
   <h1>Call Queue Dashboard</h1>
 
   <div class="grid">
     <div>
       <div class="panel">
 
         <div class="kpi-row">
           <div class="kpi"><div class="label">Pending</div><div id="pending" class="value">0</div></div>
           <div class="kpi"><div class="label">Processing</div><div id="processing" class="value">0</div></div>
           <div class="kpi"><div class="label">Completed</div><div id="completed" class="value">0</div></div>
         </div>
 
         <div class="kpi-row" style="margin-top:12px">
           <div class="kpi"><div class="label">Active Calls</div><div id="active" class="value">0</div></div>
           <div class="kpi"><div class="label">Total Made</div><div id="totalMade" class="value">0</div></div>
           <div class="kpi"><div class="label">Total Resolved</div><div id="totalResolved" class="value">0</div></div>
         </div>
 
         <div style="margin-top:12px">
           <div class="label">Global Rate</div>
           <div class="rates">
             <div class="rate-pill">Limit: <span id="limit">-</span></div>
             <div class="rate-pill">Used/min: <span id="used">-</span></div>
             <div class="rate-pill">Per-port share: <span id="perPort">-</span></div>
           </div>
         </div>
 
         <div class="upload-box">
           <strong>Upload Calls</strong><br><br>
           <input id="file" type="file" accept=".csv,.xls,.xlsx" />
           <br><br>
           <button onclick="upload()">Upload</button>
           <span id="status" style="margin-left:10px;color:#444"></span>
         </div>
 
         <div style="margin-top:16px">
           <button class="secondary" onclick="resetAll()">Reset Calls</button>
         </div>
 
       </div>
     </div>
 
     <div>
       <div class="panel">
         <strong>Export / Debug</strong><br><br>
         <button onclick="download()">Download Completed</button>
         <button class="warn" onclick="clearOut()">Clear</button>
         <pre id="exportOut"></pre>
       </div>
     </div>
   </div>
 </div>
 
 <script>
 const API = location.hostname === "localhost"
   ? location.protocol + "//" + location.hostname + ":3000"
   : location.origin;
 
 const socket = io(API);
 
 socket.on("stats", s => {
   pending.textContent = s.pending;
   processing.textContent = s.processing;
   completed.textContent = s.completed;
   active.textContent = s.active;
   totalMade.textContent = s.totalMade;
   totalResolved.textContent = s.totalResolved;
   limit.textContent = s.globalRatePerMin;
   used.textContent = s.globalRateThisMin;
   perPort.textContent = s.perSessionLimit;
 });
 
 socket.emit("request-stats");
 setInterval(() => socket.emit("request-stats"), 3000);
 
 function parse(file){
   return new Promise(r=>{
     const fr=new FileReader();
     fr.onload=e=>{
       const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
       r(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
     };
     fr.readAsArrayBuffer(file);
   });
 }
 
 async function upload(){
   if(!file.files.length) return alert("Choose file");
   const data = await parse(file.files[0]);
   status.textContent = `Uploading ${data.length} records...`;
 
   await fetch(API+"/upload",{
     method:"POST",
     headers:{'Content-Type':'application/json'},
     body:JSON.stringify({ records:data })
   });
 
   status.textContent="Upload done";
 }
 
 async function resetAll(){
   if(confirm("Reset all?")){
     await fetch(API+"/reset",{method:"POST"});
     socket.emit("request-stats");
     exportOut.textContent="";
   }
 }
 
//  async function download(){
//    const d=await fetch(API+"/export-completed").then(r=>r.json());
//    exportOut.textContent=JSON.stringify(d,null,2);
//  }
async function download() {
  try {
    const data = await fetch(API + "/export-completed").then(r => r.json());
    const jsonStr = JSON.stringify(data, null, 2);

    // Create a Blob from JSON string
    const blob = new Blob([jsonStr], { type: "application/json" });

    // Create a temporary link element
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "completed_jobs.json"; // Name of the downloaded file
    document.body.appendChild(a); // Required for Firefox
    a.click(); // Trigger download
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Optional: Show JSON in preview
    exportOut.textContent = jsonStr;
  } catch (err) {
    console.error("Download failed", err);
    alert("Download failed. Check console for details.");
  }
}

 function clearOut(){ exportOut.textContent=""; }
 </script>
 </body>
 </html>
 